<div container="true"/>
<div container='true'>
<div class="tableform">
    <ul class="finder-action-items flt">
        <li style="float:left;">
        <a target='_blank' href="index.php?app=business&ctl=admin_settlement&act=export_list&settlement_no=<{$settlement_no}>">
        <span>导出结算模板</span>
        </a>
        </li>
        <li style="float:left;">
        <a href="javascript:void(0);" onclick="do_import_settlement();">
        <span>导入结算数据</span>
        </a>
        </li>
        <li style="float:left;">
        <a href="javascript:void(0);" onclick="do_settlement();">
        <span>结算</span>
        </a>
        </li>
    </ul>
	<div class="settlement_upload" hidden="true">
		<form method="POST" id='settlement_edit_form' action="index.php?app=business&ctl=admin_settlement&act=import_settlement" class="tableform" enctype="multipart/form-data">
			<div class="division">
				<table width="100%">
					<tbody>
						<tr>
							<input type="hidden" name="settlement_no" value="<{$settlement_no}>"/>
						</tr>
						<tr>
							<th style="padding-top:12px;"><{t}>上传文件：<{/t}></th>
							<td><input type="file" name="settlement_file" id="settlement_file"></td>
						</tr>
					</tbody>
				</table>
				<{button type="submit"  label=$___b2c="保存"|t:'b2c' id='import_settlement_submit'}>
			</div>
		</form>
	</div>
	<div class="do_settlement" hidden="true">
		<form method="POST" id='do_settlement_form' action="index.php?app=business&ctl=admin_settlement&act=do_settlement" class="tableform">
			<div class="division">
				<table width="100%">
					<tbody>
						<tr>
							<input type="hidden" name="settlement_no" value="<{$settlement_no}>"/>
						</tr>
					</tbody>
				</table>
				<{button type="submit"  label=$___b2c="保存"|t:'b2c' id='do_settlement_submit'}>
			</div>
		</form>
	</div>
    <table class="gridlist" width="100%" border="0" cellspacing="0" cellpadding="0">
	<thead>
       <tr>
          <th><{t}>订单号<{/t}></th>
          <th><{t}>结算金额<{/t}></th>
          <th><{t}>实际结算金额<{/t}></th>
          <th><{t}>结算状态<{/t}></th>
       </tr>
    </thead>
	<tbody>
        <{if $result}>
            <{foreach from=$result item=result key=key}>
              <tr>  
                 <td><a target='_blank' href="index.php?app=b2c&ctl=admin_order&act=index&action=detail&id=<{$result.order_id}>&singlepage=true&finderview=detail_basic"><{$result.order_id}></a></td>
                 <td style="color:red;font-weight:bold;"><{$result.account}></td>
                 <{if $result.real_account==0}><td style="font-weight:bold;">-</td><{else}><td style="color:<{if $result.real_account>$result.account}>green<{elseif $result.real_account<$result.account}>blue<{else}>red<{/if}>;font-weight:bold;"><{$result.real_account}></td><{/if}>
                 <td style="font-weight:bold;"><{if $result.is_balance=='1'}>已结算<{elseif $result.is_balance=='2'}>未结算<{elseif $result.is_balance=='3'}>待结算<{/if}></td>
              </tr>
            <{/foreach}>
        <{else}>
            <tr><td style="text-align:center;" colspan="12">无结算数据</td></tr>
        <{/if}>
       
	</tbody>
    </table>
     <{$pager}>
</div>
</div>

<script>
	var finder = finderGroup['<{$env.get.finder_id}>'];

	$('settlement_file').addEvent('change',function(){
		if($('settlement_file').value!=''){
			$("import_settlement_submit").click();
		}
	});
	$('settlement_edit_form').store('target',{
		onComplete:function(e){
			finder.refresh();
			if(e.lastIndexOf(',') - e.indexOf(',') > 17)e = getShortString(e,',',3);
			if(e!='')alert(e);
		},
	});
	$('do_settlement_form').store('target',{
		onComplete:function(e){
			finder.refresh();
			if(e!='')alert(e);
		},
	});

    function do_import_settlement(){
		$('settlement_file').click();
	}
    function do_settlement(){
		if(confirm('确定结算？')){
			$("do_settlement_submit").click();
		}
	}

	//避免提示信息过长
	function getShortString(str,split,keep){
		var pos = 0;
		for(i=0;i<keep;i++){
			pos = str.indexOf(split,pos)+1;
		}
		str = str.substr(0,pos)+'...';
		return str;
	}
</script>