<div class='buyinfo clearfix'>
  <label><{t}>数量：&nbsp;
				<font style="color:#CDCDCD">
					Quantity
				</font>
  <{/t}></label>
  <ul style="float: left;">
    <li>
    <div class="Numinput numinputModi">
       	<span class="substract"></span>
        <span class="plus" id="plus"></span>
        <input type="text" value="1" size="5" name="goods[num]" min="0" class="Num" id="Num">
        <div class="numadjust-arr"><span class="numadjust increase"></span> <span class="numadjust decrease"></span></div>
      </div>

    </li>
    <li style="display:none;"><{if $goods.package_unit}><{$goods.package_unit}><{t}>(每<{/t}><{$goods.package_scale}><{t}>个一<{/t}><{$goods.package_unit}>)<{/if}></li>
    <li>
      <span>&nbsp;&nbsp;(<{t}>当前库存:
				<font style="color:#CDCDCD">
					Stock
				</font>
			<{/t}>
        <span class='store' id='stock' updatespec="text_store" ><{if $goods.nostore_sell}>9999+<{else}><{$goods.store - $goods.freez}><{/if}></span> 件)
      </span>
    </li>
  </ul>
</div>
<!--================================== 购买 按钮 ==============================-->
<input type="hidden" name="goods[goods_id]" value="<{$goods.goods_id}>" />
<input type="hidden" name="goods[pmt_id]" value="<{$goods.pmt_id}>" />

<input type='hidden' name='goods[product_id]' updatespec="updatepid" value='<{$product0id}>'/>
 <div class="btnBar clearfix" <{if count($goods.product)<0}>style="visibility:hidden"<{/if}>></div>

<script>
   var keyCodeFix=[48,49,50,51,52,53,54,55,56,57,96,97,98,99,100,101,102,103,104,105,8,9,46,37,39<{if $goods.type.floatstore}>,110,190<{/if}>];


/*购买数量调节*/

     var getStore=function(){
        return  $('goods-viewer').getElement('.buy-limit-storess')?$('goods-viewer').getElement('.buy-limit-storess').get('text').toInt():$('goods-viewer').getElement('.buyinfo .store').get('text').toInt();
     };

     $$('#goods-viewer .buyinfo .numadjust').addEvent('click',function(e){
          var countText=$('goods-viewer').getElement('.buyinfo input[name^=goods[num]');
          if(this.hasClass('increase')){
             countText.set('value',(countText.value.toInt()+1).limit(1,getStore()));
          }else{
             countText.set('value',(countText.value.toInt()-1).limit(1,getStore()));
          }
          this.blur();
     });

     $('goods-viewer').getElement('.buyinfo input[name="goods[num]"]').addEvents({
        'keydown': function(e){
            if(!keyCodeFix.contains(e.code)){
               e.stop();
            }
        },
        'keyup': function(e){
        	var clra = document.getElementsByName('goods[cards_pass_type]');
        	for(var i=0;i<clra.length;i++)
            {
         	   if(clra[i].checked){ 
         		   var thissell = clra[i].value;
         		}
            }
            <{if $source == 'internal'}>
              var storess=<{$goods.virtual}>;
           <{else}>
             if(thissell == 'entity'){
                var storess=<{$goods.entity}>;
              }else{
                var storess=<{$goods.virtual}>
              }
           <{/if}>
            if(storess<this.value)this.value=storess;
            if (!this.value || <{if $goods.type.floatstore==='1'}>this.value.toFloat() < 0<{else}>this.value.toInt() < 1<{/if}>) this.value = 1;
            
            if(1<this.value.toInt()<storess){
                	document.getElementById('stock').innerHTML=storess-this.value.toInt();
             }
            
        },
        'blur': function(e) {
            if (<{if $goods.type.floatstore==='1'}>this.value.toFloat() <= 0<{else}>this.value.toInt() < 1<{/if}>) this.value = 1;
            <{if $goods.type.floatstore==='1'}>else this.value = this.value.toFloat();<{/if}>
        }
     });

      $('goods-viewer').getElement('.substract').addEvent('click',function(e){

         var val=$('goods-viewer').getElement('.Num').get('value');

         if(val!=1)
             {
                 var vals=parseInt(val)-1;

                $('goods-viewer').getElement('.Num').set('value',vals);
                document.getElementById('stock').innerHTML=parseInt(document.getElementById('stock').innerHTML)+1;
             }
     });
      
      $('goods-viewer').getElement('.plus').addEvent('click',function(e){
          var val=$('goods-viewer').getElement('.Num').get('value');
          //var freez='<{$goods.freez}>';
          var nostore_sell='<{$goods.nostore_sell}>';
          var clra = document.getElementsByName('goods[cards_pass_type]');
          for(var i=0;i<clra.length;i++)
          {
       	   if(clra[i].checked){ 
       		   var thissell = clra[i].value;
       		}
          }
          <{if $source == 'internal'}>
              var storess=<{$goods.virtual}>;
           <{else}>
             if(thissell == 'entity'){
                var storess=<{$goods.entity}>;
              }else{
                var storess=<{$goods.virtual}>
              }
           <{/if}>
              
                 // var storeNum=storess-freez;
                  var vals=parseInt(val)+1;
                  var storeky =storess - vals;
                  if(val<storess)
                      {
                          $('goods-viewer').getElement('.Num').set('value',vals);                          
                          document.getElementById('stock').innerHTML=storeky;
                      } 
  		});
  	    
      
               
           //var store='<{$goods.store}>';

       window.addEvent("domready",function(){
    	   function checkstore(){
               var entity = <{$goods.entity}>;
        	   var virtual = <{$goods.virtual}>;
        	   var stock = document.getElementById('stock');
        	   var clra = document.getElementsByName('goods[cards_pass_type]');
        	   var buybutton=document.getElementById('btn_lj');
        	   var qhbutton=document.getElementById('selout');
               for(var i=0;i<clra.length;i++)
               {
            	   if(clra[i].checked){ 
            		   var thissell = clra[i].value;
            		}
            	   
            	   if(thissell == 'entity'){       		   
            			if(entity>0){
            				stock.innerHTML=entity;
            				buybutton.style.display='block';
            				qhbutton.style.display='none';
            			}else{
            				stock.innerHTML=0;
            				buybutton.style.display='none';
            				qhbutton.style.display='block';
            			}  
            	   }
            	   if(thissell == 'virtual'){                 		   
           				if(virtual>0){
           					stock.innerHTML=virtual;
           					buybutton.style.display='block';
            				qhbutton.style.display='none';
           				}else{
           					stock.innerHTML=0;
           					buybutton.style.display='none';
            				qhbutton.style.display='block';
           				}  
           	   		} 
            	   clra[i].onclick=function(){
              		 checkstore();
              		 var num =document.getElementById('Num').value=1;
              	   }
    		   
    	   		}
    	   }
    	   checkstore();   	     
		});
       
</script>
