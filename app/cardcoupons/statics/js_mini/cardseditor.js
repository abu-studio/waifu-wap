var ShopExGoodsEditor=new Class({Implements:[Options],options:{periodical:false,delay:500,postvar:"finderItems",varname:"items",width:500,height:400},initialize:function(A,B){this.el=$(A);this.setOptions(B);this.cat_id=$("gEditor-GCat-input").get("value");this.type_id=$("gEditor-GType-input").get("value");this.goods_id=$("gEditor-GId-input").get("value");this.initEditorBody.call(this)},catalogSelect:function(B,C){B=B||1;var A=$("gEditor-GType-input");if(B!=A.get("value")){if(confirm(LANG_goodseditor["comfirm"])||C<0){A.getElement("option[value="+B+"]").set("selected",true);this.updateEditorBody.call(this)}}this.cat_id=C},initEditorBody:function(){var A=this;var C=$("gEditor-GCat-input");var B=$("gEditor-GType-input");B.addEvent("click",function(){this.store("tempvalue",this.get("value"))});B.addEvent("change",function(D){var E=this.retrieve("tempvalue");if(this.get("value")&&confirm(LANG_goodseditor["comfirm"])){A.updateEditorBody.call(A);A.type_id=this.get("value")}else{this.getElement("option[value="+E+"]").set("selected",true)}})},updateEditorBody:function(B){try{if($("productNode")&&$("productNode").retrieve("specOBJ")){$("productNode").appendChild($("productNode").retrieve("specOBJ").toHideInput($("productNode").getElement("tr")))}}catch(A){}var C={method:"post",data:$("gEditor").toQueryString(),url:"index.php?app=cardcoupons&ctl=admin_cards_editor&act=update",evalScripts:false,onComplete:function(F){var D={"#menu-desktop":$("menu-desktop"),"#gEditor-Body":$("gEditor-Body")};F=F.replace(/<\!-{5}(.*?)-{5}([\s\S]*?)-{5}(.*?)-{5}>/g,function(){var H=arguments[1];H=D[H]||$(H);var G=arguments[2]||null;if(G&&H){H.empty().set("html",G).fixEmpty()}return""});var E="";this.response.text.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,function(G,H){E+=H+"\n";return""});Browser.exec(E);goodsEditFrame()}};new Request(C).send()},mprice:function(B){for(var A=$(B).getParent();A.tagName!="TR";A=A.getParent()){}var C={};A.getElements("input").each(function(D){if(D.name=="price[]"){C["price"]=D.value}else{if(D.name=="goods[product][0][price]"){C["price"]=D.value}else{if(D.getAttribute("level")){C["level["+D.getAttribute("level")+"]"]=D.value}}}});window.fbox=new Dialog("index.php?app=cardcoupons&ctl=admin_cards_editor&act=set_mprice",{title:LANG_goodseditor["editvipprice"],ajaxoptions:{data:C,method:"post"},modal:true});window.fbox.onSelect=goodsEditor.setMprice.bind({base:goodsEditor,"el":A})},setMprice:function(B){var A={};B.each(function(C){A[C.name]=C.value});this.el.getElements("input").each(function(C){var D=C.getAttribute("level");if(D&&A[D]!=undefined){C.value=A[D]}})},spec:{addCol:function(A,B){this.dialog=new Dialog("index.php?app=b2c&ctl=admin_products&act=set_spec&_form="+(A?A:"goods-spec")+"&p[0]="+B,{ajaxoptions:{data:$("goods-spec").toQueryString()+($("nospec_body")?"&"+$("nospec_body").toQueryString():""),method:"post"},title:LANG_goodseditor["type"]})},addRow:function(){this.dialog=new Dialog("index.php?app=b2c&ctl=admin_goods_editor/spec&act=addRow",{ajaxoptions:{data:$("goods-spec"),method:"post"}})}},adj:{addGrp:function(A){this.dialog=new Dialog("index.php?app=cardcoupons&ctl=admin_cards_editor&act=addGrp&goods_id="+this.goods_id+"&_form="+(A?A:"goods-adj"),{title:LANG_goodseditor["widget"]})}},pic:{del:function(A){if(confirm(LANG_goodseditor["comfirmDelPic"])){A=$(A);var D=A.getParent(".gpic-box"),C=D.getNext(".gpic-box");try{if(A.get("ident")){if($$("#all-pics input[name=image_default]")[0]){$$("#all-pics input[name=image_default]")[0].value=A.get("ident")}$("all-pics").eliminate("cururl");D.destroy()}}catch(B){D.destroy()}if(C){C.getElement(".gpic").onclick()}}},setDefault:function(G,B){var F=$(B).getParent(".pic-main");var D=F.getElement(".pic-area");var E=$E(".gpic[image_id="+G+"]",D);if(E.hasClass("current")){return}var A,C;if(A=$E(".current",D)){A.removeClass("current")}if(C=$E("input[name=image_default]",D)){C.set("value",G)}E.addClass("current")},getDefault:function(){var B=obj.getParent(".pic-main");var C=B.getElement(".pic-area");var A=$E("input[name=image_default]",C);if(A){return A.value}else{return false}},viewSource:function(A){return new Dialog(A,{title:LANG_goodseditor["viewSource"],singlon:false,"width":650,"height":300})}},rateGoods:{add:function(){window.fbox=new Dialog("index.php?ctl=goods/product&act=select",{modal:true,ajaxoptions:{data:{onfinish:"goodsEditor.rateGoods.insert(data)"},method:"post"}})},del:function(){},insert:function(A){$$("div.rate-goods").each(function(B){A["has["+B.getAttribute("goods_id")+"]"]=1});new Request({url:"index.php?ctl=goods/product&act=ratelist",data:A,onComplete:function(B){$("x-rate-goods").innerHTML+=B}}).send()}}});var CatalogSelect=new Class({Implements:[Events,Options],options:{updateMain:"catalog-x",url:"index.php?app=b2c&ctl=admin_goods_cat&act=get_subcat_list",childClass:".subs",params:"p[0]"},initialize:function(A,C){if(!A){return}this.handle=$(A);this.setOptions(C);var B=this.options;this.url=B.url;this.updateMain=$(B.updateMain);if(!this.updateMain||!this.url){return}this.cacheHS={};this.load.call(this)},load:function(){this.request("0")},attach:function(){var A=this;this.updateMain.getElements(this.options.childClass).addEvent("click",function(B){var C=this.get("id")||this.get("pid");if(this.hasClass("cat-no-child")){A.callback("",this.get("text"));return document.body.fireEvent("click",B)}return A.isCache(C)});this.updateMain.getElements(".cat-child").addEvent("click",function(B){var C=this.getParent("*[type_id]");if(!C){return}A.callback(C.id,this.get("text"),C.get("type_id"));document.body.fireEvent("click",B)})},isCache:function(A){this.cacheHS.id?this.updateMain.innerHTML=this.getCache(A):this.request(A);this.fireEvent("show").attach.call(this)},request:function(){var A=this;var C=Array.flatten(arguments);var B=C.link({"options":Object.type,"id":String.type});B.options=Object.append(B.options||{},{url:this.url,data:this.options.params+"="+B.id,method:"get",onComplete:function(D){A.updateMain.innerHTML=D;A.setCache(B.id,D).attach();A.fireEvent("show")}});new Request(B.options).send();return this},callback:function(D,B,C){var A=this.handle.getElement(".label").set("text",B);if(this.handle.getElement("input[type=hidden]")){this.handle.getElement("input[type=hidden]").value=D}this.fireEvent("callback",[D,C,B])},setCache:function(B,A){if(this.cacheHS[B]==undefined){this.cacheHS[B]=A}return this},getCache:function(A){return this.cacheHS[A]}});